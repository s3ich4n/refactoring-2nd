# 1장

예시를 토대로 살펴봅시다.

## 1.1. 시작해봅시다

코드 따라치는데 대체로 비슷하게 했다.

요구사항

- 공연요청, 관객규모를 기초로 비용을 책정하는 프로그램 작성
- 비극, 희극만 궁연함
- 공연료와 포인트(`volume_credit`)을 지급해서, 다음 번 의뢰시 공연료 할인도 가능함

## 1.2. 예시 프로그램을 본 소감

쉽지않다 ㅋㅋ

그래도 어쨌든 작동한다. 그런데 설계가 나쁘면 고치기가 어렵다. 손대기가 어려우면 버그가 날 가능성이 높아진다.

코드 수정이 필요하면? 작동방식을 쉽게 파악할 수 있도록 코드를 여러 함수와 프로그램 요소로 재구성한다.
구조부터 다시 잡고 기능을 수정하는 편이 좋다.

> 프로그램이 새 기능을 추가하기 편한 구조가 아니면, 기능을 잡기 쉬운 구조로 바꾸자.

### 추가 요구사항 (1)

"청구내역을 HTML로 출력해야한다" 면...

현재 `statement()` 을 그대로 쓰면 함수가 너무 복잡해진다.

대안 1: 함수 복붙 후 거기서 HTML을 출력(`html_statement()`)

한번 짜고 말 코드면 그래도 되지만, 오래 쓸 프로그램이면 골치아파진다.

### 추가 요구사항 (2)

배우가 연기하고 싶은 장르가 많아진다면, 공연료 및 적립 포인트 계산방식도 바뀐다. "거의 확실히 바뀐다".

대안 2: 또 함수 복붙 후 로직 수정

그럼 대안 1에서 만든 `html_statement()` 에도 반영해야한다.

정책이 복잡해지면 수정할 부분 찾기도 힘들고 실수도 필연적이다.

### 그래서...

리팩터링은 변경을 위해 필요하다.

## 1.3. 리팩터링의 첫 단계

1. 테스트코드를 마련한다.
    - 청구서 몇개를 준비하고
    - `statement()` 의 정답 문자열과 비교한다.
    - 단축키 딸깍으로 테스트를 바로 볼 수 있게 세팅한다.

> 리팩터링 하기 전에 테스트부터 마련한다. 테스트는 자가진단하도록 만든다

## 1.4. `statement()` 함수 쪼개기

전체 동작을 각각의 부분으로 나누는 지점부터 물색 -- switch case[^1]

이런 switch문은 코드 스스로가 할 수 있도록 함수로 추출해야한다[^2]. 이름은 `amount_for(a_performance)` 정도로.

PyCharm에는 Refactor 단축키 입력 후 Extract Method를 하면 된다.

원래는 별도 메소드로 빼주는데, 책에서 nested function으로 처리해서 이를 동일하게 반영했다.

변수명을 일괄적으로 바꾸는 것도 IDE가 해준다.
매개변수의 역할이 명확하지 않으면 `a/the` 를 붙이는 건 영어가 모자라서 이해를 못했지만,
아무튼 그런 접근을 해야된단 건 배웠다.

### `play` 변수 제거하기

`amount_for()` 의 매개변수를 살펴보면, `a_performance`는 어차피 루프변수에서 온다.
`play` 는 개별 공연(`a_performance`)에서 온다.
그러면 `amount_for()` 안에서 계산하는 편이 낫다.

임시변수를 최소화해서 추출을 단순화한다.
이는 임시 변수를 질의 함수로 바꾸기[^3]라고 한다.

변수를 인라인 처리[^4]했다.
이후 변수 인라인으로 인해 함수 선언을 바꿀[^5] 수 있었다.
불필요한 파라미터를 지운 건 덤이다.

근데 이렇게 리팩터링 하면 루프 한번 돌 때마다 공연을 조회했는데, 이러면 세 번 조회한다.
제대로 리팩터되면 성능개선도 금방 할 수 있다.

다시 호출부로 돌아간다. `amount_for()` 는 임시 변수인 this_amount에 값을 설정하는데 쓰지만 그 값이 바뀌진 않는다.
변수 인라인하기를 재적용한다.

### 적립 포인트 계산 코드 추출하기

점점 나아지고있다... 이제 적립 포인트 계산 로직을 추출하자.
`perf` 변수도 간단히 전달만 하자. 그런데 `volume_credits` 는 반복하면서 값을 누적해야한다
=> 추출한 함수에서 `volume_credits`의 복제본을 초기화하고 계산결과를 반환하면 된다.

### `format` 변수 제거하기

임시변수는 문제를 일으키기 쉬우므로 이를 지운다.
그 대상은 `format` 이다. 가장 쉬운 방법은 함수 변수를 일반 함수로 바꾸는 정도다.
이름 짓기도 매우 중요하기 때문에 함수 선언 바꾸기를 또 썼다.
하는 김에 비즈니스 로직도 메소드에 추가했다.

### `volume_credits` 변수 없애기

반복문을 돌 때마다 값이 누적되는 걸 살펴보기 까다로우므로 반복문 쪼개기[^6]를 이용해 별도로 빼낸다.
이 후 문장 슬라이드하기[^7]로 `volume_credits` 변수를 선언하는 문장을 반복문 바로 뒤로 옮겼다.

`volume_credits` 값 갱신과 관련한 코드를 한데 모아두면 임시 변수를 질의 함수로 바꾸기가 쉬워진다.
이를 위해 함수로 추출부터 다시 한번 해본다. 잘 끝났으면 변수를 인라인한다.

앞서 말한 리팩터링으로 인한 성능저하가 염려될 수 있다.
설령 그렇다 하더라도 다듬어진 코드로 성능 개선을 하는게 훨씬 쉽다.

성능은 "특별한 경우가 아니라면 일단 무시"한다.

`volume_credits`는 4단계로 잘게 나눴다:

1. 반복문을 쪼갰고 (`62955c57`)
2. 문장 슬라이드를 했고 (`9bbb6536`)
3. 함수를 추출했고 (`2bc5c439`)
4. 변수를 인라인했다 (`2c57d61d`)

똑같은 작업을 `total_amount` 에서도 해보자.

1. 함수를 추출했고 (`73572616`)
2. 변수를 인라인했다 (`3d1fe1eb`)

[^1]: 파이썬에서는 pattern match 구문
[^2]: `6.1`절, 함수 추출하기
[^3]: `7.4`절, 임시 변수를 질의 함수로 바꾸기
[^4]: `6.4`절, 변수 인라인하기
[^5]: `6.5`절, 함수 선언 바꾸기
[^6]: `8.7`절, 반복문 쪼개기
[^7]: `8.6`절, 문장 슬라이드하기